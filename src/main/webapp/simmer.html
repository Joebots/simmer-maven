<!DOCTYPE html>
<html>
<head>
    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">-->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport"
          content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <!-- Properties can be specified to influence deferred binding -->
    <meta name="gwt:property" content="locale=en_US"/>

    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/burner.css">

    <script src="lib/jquery-1.12.3.min.js"></script>

    <script src="lib/event-bus-bundle.js"></script>
    <script src="lib/raphael.min.js"></script>
    <script src="lib/burner.js"></script>

    <!-- Configuration -->
    <script>
        const ARDUINO_GPIO = {
            GPIO_2: "2",
            GPIO_3: "3",
            GPIO_4: "4",
            GPIO_5: "5",
            GPIO_6: "6",
            GPIO_7: "7",
            GPIO_8: "8",
            GPIO_9: "9",
            GPIO_10: "10",
            GPIO_11: "11",
            GPIO_12: "12",
            GPIO_13: "13"
        };
        const RASPBERRY_PI3_GPIO = {
            GPIO_2: "3",
            GPIO_3: "5",
            GPIO_4: "7",
            GPIO_5: "29",
            GPIO_6: "31",
            GPIO_7: "26",
            GPIO_8: "24",
            GPIO_9: "21",
            GPIO_10: "19",
            GPIO_11: "23",
            GPIO_12: "32",
            GPIO_13: "33",
            GPIO_14: "8",
            GPIO_15: "10",
            GPIO_16: "36",
            GPIO_17: "11",
            GPIO_18: "12",
            GPIO_19: "35",
            GPIO_20: "38",
            GPIO_21: "40",
            GPIO_22: "15",
            GPIO_23: "16",
            GPIO_24: "18",
            GPIO_25: "22",
            GPIO_26: "37",
            GPIO_27: "13"
        };
        const ODROID_C2_GPIO = {
            GPIO_0: "11",
            GPIO_1: "12",
            GPIO_2: "13",
            GPIO_3: "15",
            GPIO_4: "16",
            GPIO_5: "18",
            GPIO_6: "22",
            GPIO_7: "7",
            GPIO_10: "24",
            GPIO_11: "26",
            GPIO_12: "19",
            GPIO_13: "21",
            GPIO_14: "23",
            GPIO_21: "29",
            GPIO_22: "31",
            GPIO_23: "33",
            GPIO_24: "35",
            GPIO_26: "32",
            GPIO_27: "36"
        };
        var GpioConfig = ARDUINO_GPIO;

        var globalBus;

        var mm = function (value) {
            return Math.floor(value / 0.169);
        };

        // physical dimensions of breadboard
        // w: 65 mm, h: 112 mm
        // 1 pair (PWR and GND), 2 terminal + 1 GPIO columns, 38 rows
        var rows = 38;
        var pitch = mm(2.54);
        var rowWidth = 7 * pitch;

        var topMargin = mm(11);
        var leftMargin = mm(5);

        var BreadboardConfig = {
            width: mm(65),
            height: mm(112),
            thickness: mm(2),
            pitch: pitch,
            banks: [
                {type: "BUS", rows: 2, y: topMargin, x: leftMargin, height: pitch * rows, dir: 'y'},
                {type: "TERMINAL", rows: rows, y: topMargin, x: mm(16), width: rowWidth},
                {type: "TERMINAL", rows: rows, y: topMargin, x: mm(36), width: rowWidth},
                {type: "GPIO", rows: rows, y: topMargin, x: mm(62), width: rowWidth}
            ]
        };

        var SimmerOptions = {
            SHOW_CURRENT: true,
            SHOW_VOLTAGE: true,
            SHOW_POWER: false,
            SHOW_VALUES: true,
            SMALL_GRID: false,
            EURO_RESISTORS: false,
            WHITE_BACKGROUND: false,
            CONVENTIONAL_CURRENT_MOTION: true,
            SIMULATION_SPEED: 117,
            CURRENT_SPEED: 50
        };
    </script>

    <!-- Google Blockly -->
    <script src="lib/blockly/blockly_compressed.js"></script>
    <script src="lib/blockly/blocks_compressed.js"></script>
    <script src="lib/blockly/javascript_compressed.js"></script>
    <script src="lib/blockly/python_compressed.js"></script>
    <script src="lib/blockly/msg/js/en.js"></script>
    <!-- Custom GPIO Blocks -->
    <script src="lib/blocks/gpio.js"></script>
    <script src="lib/blocks/text.js"></script>
    <script src="lib/blocks/time.js"></script>
    <!-- Acorn JS Interpreter -->
    <script src="lib/acorn/acorn_interpreter.js"></script>
    <!--  Prettify -->
    <script src="lib/prettify/prettify.js"></script>
    <link rel="stylesheet" type="text/css" href="lib/prettify/prettify.css">
    <!-- Custom Scripts -->
    <script src="lib/browser_interpreter.js"></script>
    <script src="lib/simmer_api.js"></script>
    <script src="lib/blockly_gpio.js"></script>
    <script src="lib/script_executor.js"></script>
</head>

<body>

<div id="burner-controls" class="container">
    <div class="row">
        <a class="col s2 btn btn-large waves-effect waves-light" id="back-btn"><i
                class="material-icons">chevron_left</i> Back</a>
        <div class="col s8 burner-command-desc" id="wizard-text"></div>
        <a class="col s2 btn btn-large waves-effect waves-light" id="forward-btn">Next <i class="material-icons">chevron_right</i></a>
    </div>
</div>

<div id="app-controls">
    <div id="wizard-toolbar">
        <a id="oscope" class="btn-floating btn-large waves-effect waves-light"><i
                class="material-icons">timeline</i></a>
        <a id="reset" class="btn-floating btn-large waves-effect waves-light"><i class="material-icons">cached</i></a>
    </div>
</div>
<div id="active-component"></div>
<div id="active-pin"></div>
<div id="active-component-picture"></div>

<script src="simmer/simmer.nocache.js"></script>

<script>
    $(function () {
        console.log("loading");
        globalBus = new EventBus();

        var bboard = new BreadBoard(BreadboardConfig);

        globalBus.bind(BreadBoard.CircuitStates.CIRCUIT_WORKING, function (e) {
            bboard.layout(e.model);
            window.workingCircuitEvent = e;
        });

        globalBus.bind(BreadBoard.CircuitStates.CIRCUIT_BROKEN_ANY, function (e) {
            console.log("BROKEN");
        });

        globalBus.bind(".*", function (evt) {
            console.log(evt.model);
        });

        globalBus.bind(BreadBoard.CircuitStates.SYSTEM_LOADED, function (e) {
            console.log("system.loaded");
            bboard.setTarget("breadboard");
            //bboard.showAllBanks();
        });

        $("#bblayout").click(function (evt) {
            top.ALLOW_BB_MOVE = top.ALLOW_BB_MOVE ? !top.ALLOW_BB_MOVE : true;
        });

        $("#reset").click(function (evt) {
            globalBus.fire("circuit.working", window.workingCircuitEvent);
            $("#wizard-text").html("");
        });

        $("#oscope").click(function (evt) {
            $("#burner-controls").fadeToggle();
        });
    });
</script>
</body>
</html>
